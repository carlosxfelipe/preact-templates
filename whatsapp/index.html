<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FIIs, Fiagros, FI-Infra</title>
    <script src="https://unpkg.com/preact@latest/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script src="https://unpkg.com/preact@latest/hooks/dist/hooks.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: sans-serif;
        background-color: #ece5dd;
        margin: 0;
      }

      :root {
        --app-height: 100vh;
      }
    </style>
    <script>
      window.addEventListener("resize", () => {
        document.documentElement.style.setProperty(
          "--app-height",
          `${window.innerHeight}px`
        );
      });
      document.documentElement.style.setProperty(
        "--app-height",
        `${window.innerHeight}px`
      );
    </script>
  </head>
  <body class="w-full" style="height: var(--app-height)">
    <div id="app" class="w-full h-full flex flex-col bg-[#ece5dd]"></div>

    <script type="module">
      const { h, render } = preact;
      const { useState, useRef, useEffect } = preactHooks;
      const html = htm.bind(h);

      function ChatApp() {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [loading, setLoading] = useState(false);
        const messagesEndRef = useRef(null);

        const getGreeting = () => {
          const hour = new Date().getHours();
          if (hour < 12) return "Bom dia!";
          if (hour < 18) return "Boa tarde!";
          return "Boa noite!";
        };

        useEffect(() => {
          const greeting = getGreeting();
          setMessages([{ sender: "bot", text: greeting }]);
        }, []);

        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);

        const sendMessage = async () => {
          if (!input.trim()) return;

          const userMsg = { sender: "user", text: input };
          setMessages((prev) => [...prev, userMsg]);
          setInput("");
          setLoading(true);

          try {
            const res = await fetch(
              "https://gemini-chat-7d5w.onrender.com/gemini/chat/investment-advisor",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [
                    {
                      role: "user",
                      parts: [{ text: input }],
                    },
                  ],
                }),
              }
            );

            const data = await res.json();
            const reply =
              data.candidates?.[0]?.content?.parts?.[0]?.text ||
              "Desculpe, nÃ£o consegui responder.";
            setMessages((prev) => [...prev, { sender: "bot", text: reply }]);
          } catch (e) {
            setMessages((prev) => [
              ...prev,
              { sender: "bot", text: "Erro ao conectar com o servidor." },
            ]);
          } finally {
            setLoading(false);
          }
        };

        return html`
          <div class="flex flex-col w-full h-full">
            <!-- Header -->
            <div
              class="bg-[#075E54] text-white px-4 py-3 shadow flex items-center gap-3 w-full"
            >
              <img
                src="https://files.fiis.com.br/uploads/FIIs-obras-construcao-6.jpg"
                alt="Grupo WhatsApp"
                class="w-10 h-10 rounded-full object-cover"
              />
              <div class="flex flex-col">
                <div class="text-base font-semibold">
                  FIIs, Fiagros, FI-Infra
                </div>
                <a
                  href="https://chat.whatsapp.com/J1vbuJYUqpj4gZCiws94Ul"
                  target="_blank"
                  class="text-sm text-white underline opacity-80 hover:opacity-100"
                >
                  Entrar no grupo do WhatsApp
                </a>
              </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 overflow-y-auto px-2 py-3 space-y-2 w-full">
              ${messages.map(
                (msg) =>
                  html`<div
                    class="flex ${msg.sender === "user"
                      ? "justify-end"
                      : "justify-start"}"
                  >
                    <div
                      class="${msg.sender === "user"
                        ? "bg-[#dcf8c6] text-black rounded-[18px] rounded-br-none"
                        : "bg-white text-black rounded-[18px] rounded-bl-none"} px-3 py-2 max-w-[75%] text-[15px] shadow-sm whitespace-pre-line"
                    >
                      ${msg.text}
                    </div>
                  </div>`
              )}
              <div ref=${messagesEndRef}></div>
            </div>

            <!-- Input Bar -->
            <div
              class="bg-[#f0f0f0] p-2 flex items-center gap-2 sticky bottom-0 w-full z-10"
            >
              <input
                class="flex-1 rounded-full px-4 py-2 text-sm border border-gray-300 focus:outline-none"
                placeholder="Digite uma mensagem"
                value=${input}
                onInput=${(e) => setInput(e.target.value)}
                onKeyDown=${(e) => e.key === "Enter" && sendMessage()}
              />
              <button
                class="text-white bg-[#075E54] px-4 py-2 rounded-full disabled:opacity-50"
                onClick=${sendMessage}
                disabled=${loading}
              >
                ${loading ? "..." : "Enviar"}
              </button>
            </div>
          </div>
        `;
      }

      render(h(ChatApp), document.getElementById("app"));
    </script>
  </body>
</html>
