<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#075E54" />
    <title>GPTS PortalCompras</title>

    <script>
      tailwind.config = {
        darkMode: "media",
      };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/preact@latest/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script
      src="https://unpkg.com/preact@latest/hooks/dist/hooks.umd.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
      html {
        color-scheme: light dark;
      }

      body {
        font-family: sans-serif;
        margin: 0;
      }

      :root {
        --app-height: 100svh;
      }
    </style>
  </head>

  <body
    class="w-full bg-[#f0f2f5] dark:bg-[#121b22] text-black dark:text-white"
  >
    <div
      id="app"
      class="w-full relative flex flex-col"
      style="min-height: 100svh; height: var(--app-height)"
    >
    </div>

    <script type="module">
      const { h, render } = preact;
      const { useState, useRef, useEffect } = preactHooks;
      const html = htm.bind(h);

      function ChatSelector({ onSelect }) {
        const bots = [
          {
            id: "etp",
            name: "ESTUDO TÉCNICO PRELIMINAR – ETP",
            api: "https://api.mock/etp",
            image: "https://img.icons8.com/color/48/clipboard.png",
            description: "Elaboração de ETP",
          },
          {
            id: "analise-risco",
            name: "ANÁLISE DE RISCO DA CONTRATAÇÃO",
            api: "https://api.mock/analise-risco",
            image: "https://img.icons8.com/color/48/error--v1.png",
            description: "Gestão de riscos na contratação",
          },
          {
            id: "parecer-juridico",
            name: "PARECER JURÍDICO DA CONTRATAÇÃO",
            api: "https://api.mock/parecer-juridico",
            image: "https://img.icons8.com/color/48/law.png",
            description: "Avaliação jurídica do processo",
          },
          {
            id: "impugnacao-edital",
            name: "PARECER IMPUGNAÇÃO AO EDITAL",
            api: "https://api.mock/impugnacao-edital",
            image: "https://img.icons8.com/color/48/cancel.png",
            description: "Análise de impugnações",
          },
          {
            id: "parecer-tecnico",
            name: "PARECER TÉCNICO PROPOSTA",
            api: "https://api.mock/parecer-tecnico",
            image:
              "https://img.icons8.com/color/48/technical-support.png",
            description: "Análise técnica de propostas",
          },
          {
            id: "faq",
            name: "PERGUNTAS FREQUENTES – FAQ",
            api: "https://api.mock/faq",
            image: "https://img.icons8.com/color/48/faq.png",
            description: "Respostas automatizadas",
          },
          {
            id: "curso",
            name: "CURSO DE LEGISLAÇÃO E SISTEMAS DE COMPRAS",
            api: "https://api.mock/curso",
            image: "https://img.icons8.com/color/48/classroom.png",
            description: "Capacitação em compras públicas",
          },
          {
            id: "justificativa-etp",
            name: "JUSTIFICATIVA DISPENSA DO ETP",
            api: "https://api.mock/justificativa-etp",
            image: "https://img.icons8.com/color/48/document.png",
            description: "Justificativa de exceção",
          },
          {
            id: "termo-referencia",
            name: "TERMO DE REFERÊNCIA (TR)",
            api: "https://api.mock/termo-referencia",
            image: "https://img.icons8.com/color/48/task.png",
            description: "Estruturação do TR",
          },
          {
            id: "contratacao-direta",
            name: "PARECER JURÍDICO DA CONTRATAÇÃO DIRETA",
            api: "https://api.mock/contratacao-direta",
            image: "https://img.icons8.com/color/48/agreement.png",
            description: "Avaliação de contratação direta",
          },
          {
            id: "esclarecimento-edital",
            name: "RESPOSTA AO PEDIDO DE ESCLARECIMENTO DO EDITAL",
            api: "https://api.mock/esclarecimento-edital",
            image: "https://img.icons8.com/color/48/ask-question.png",
            description: "Respostas oficiais ao edital",
          },
          {
            id: "recurso-adm",
            name: "PARECER RECURSO ADMINISTRATIVO",
            api: "https://api.mock/recurso-adm",
            image: "https://img.icons8.com/color/48/decision.png",
            description: "Análise de recursos administrativos",
          },
          {
            id: "jurisprudencia",
            name: "PESQUISA DE JURISPRUDÊNCIAS EM BASES CONFIÁVEIS",
            api: "https://api.mock/jurisprudencia",
            image: "https://img.icons8.com/color/48/search.png",
            description: "Busca em bases confiáveis",
          },
          {
            id: "mapa-riscos",
            name: "MAPA DE RISCOS (TCU)",
            api: "https://api.mock/mapa-riscos",
            image: "https://img.icons8.com/color/48/graph.png",
            description: "Visualização de riscos",
          },
        ];

        return html`
          <div
            class="flex flex-col items-center bg-[#f0f2f5] dark:bg-[#121b22] text-black dark:text-white p-4 min-h-screen overflow-y-auto"
          >
            <h1 class="text-2xl font-bold mb-6 text-center">
              CONSULTAS<br /><span class="text-green-700 dark:text-green-400"
              >GPTS PORTALCOMPRAS</span>
            </h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-4xl">
              ${bots.map((bot) =>
                html`
                  <div
                    class="flex items-center gap-3 bg-white dark:bg-[#1e2a30] text-black dark:text-white p-4 rounded-lg shadow cursor-pointer hover:bg-gray-100 dark:hover:bg-[#2a3942]"
                    onClick="${() => onSelect(bot)}"
                  >
                    <img
                      src="${bot.image}"
                      alt="${bot.name}"
                      class="w-10 h-10 rounded-full object-cover"
                    />
                    <div class="text-sm">
                      <div class="font-semibold">${bot.name}</div>
                    </div>
                  </div>
                `
              )}
            </div>
          </div>
        `;
      }

      function ChatApp({ bot }) {
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [loading, setLoading] = useState(false);
        const messagesEndRef = useRef(null);

        const getGreeting = () => {
          const hour = new Date().getHours();
          if (hour >= 5 && hour < 12) return "Bom dia!";
          if (hour >= 12 && hour < 18) return "Boa tarde!";
          return "Boa noite!";
        };

        useEffect(() => {
          setMessages([{
            sender: "bot",
            text: getGreeting(),
            timestamp: new Date(),
          }]);
        }, []);

        useEffect(() => {
          messagesEndRef.current?.scrollIntoView({
            behavior: "smooth",
          });
        }, [messages]);

        const sendMessage = async () => {
          if (!input.trim()) return;
          const userMsg = {
            sender: "user",
            text: input,
            timestamp: new Date(),
          };
          setMessages((prev) => [...prev, userMsg]);
          setInput("");
          setLoading(true);

          try {
            const recentMessages = messages.slice(-6);
            const contents = [
              ...recentMessages.map((msg) => ({
                role: msg.sender === "user" ? "user" : "model",
                parts: [{ text: msg.text }],
              })),
              { role: "user", parts: [{ text: input }] },
            ];

            const res = await fetch(bot.api, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ contents }),
            });

            const data = await res.json();
            const reply =
              data.candidates?.[0]?.content?.parts?.[0]?.text ||
              "Desculpe, não consegui responder.";

            setMessages(
              (prev) => [...prev, {
                sender: "bot",
                text: reply,
                timestamp: new Date(),
              }],
            );
          } catch (e) {
            setMessages(
              (prev) => [...prev, {
                sender: "bot",
                text: "Erro ao conectar com o servidor.",
                timestamp: new Date(),
              }],
            );
          } finally {
            setLoading(false);
          }
        };

        function linkify(text) {
          const urlRegex = /(\bhttps?:\/\/[^\s)>\]]+)/g;
          return text.replace(
            urlRegex,
            (url) =>
              `<a href="${url}" class="underline text-blue-600" target="_blank" rel="noopener noreferrer">${url}</a>`,
          );
        }

        return html`
          <div
            class="flex flex-col w-full h-[var(--app-height)] bg-[#f0f2f5] dark:bg-[#121b22] text-black dark:text-white"
          >
            <div
              class="bg-[#075E54] text-white px-4 py-3 shadow flex items-center gap-3 w-full shrink-0"
            >
              <img
                src="${bot.image}"
                alt="${bot.name}"
                class="w-10 h-10 rounded-full object-cover"
              />
              <div class="flex flex-col">
                <div class="text-base font-semibold">${bot.name}</div>
                <span class="text-sm opacity-80">${bot
                  .description}</span>
              </div>
            </div>

            <div
              class="flex-1 overflow-y-auto px-2 pt-3 pb-24 scroll-pb-24 space-y-2 w-full"
            >
              ${messages.map((msg) => {
                const isUser = msg.sender === "user";
                const bubbleClass = isUser
                  ? "rounded-[18px] rounded-br-none"
                  : "rounded-[18px] rounded-bl-none";
                const bubbleStyle = isUser
                  ? "bg-[#dcf8c6] dark:bg-[#005c4b] text-black dark:text-white"
                  : "bg-white dark:bg-[#202c33] text-black dark:text-white";

                return html`
                  <div class="flex ${isUser
                    ? "justify-end"
                    : "justify-start"}">
                    <div
                      class="${bubbleStyle} ${bubbleClass} px-3 py-2 max-w-[75%] text-[15px] shadow-sm whitespace-pre-line break-words relative"
                    >
                      ${isUser
                        ? html`
                          <div>${msg.text}</div>
                        `
                        : html`
                          <div dangerouslySetInnerHTML="${{
                            __html: marked.parseInline(
                              linkify(msg.text),
                            ),
                          }}"></div>
                        `}
                      <div class="text-xs opacity-60 mt-1 text-right">
                        ${new Date(msg.timestamp).toLocaleTimeString(
                          [],
                          { hour: "2-digit", minute: "2-digit" },
                        )}
                      </div>
                    </div>
                  </div>
                `;
              })}
              <div ref="${messagesEndRef}"></div>
            </div>

            <div
              class="p-2 flex items-center gap-2 w-full z-10 bg-[#f0f0f0] dark:bg-[#1e2a30] sticky bottom-0 pb-[calc(env(safe-area-inset-bottom)+8px)]"
            >
              <input
                class="flex-1 rounded-full px-4 py-2 text-sm border border-gray-300 focus:outline-none bg-white dark:bg-[#263238] text-black dark:text-white"
                placeholder="Digite uma mensagem"
                value="${input}"
                onInput="${(e) => setInput(e.target.value)}"
                onKeyDown="${(e) => e.key === "Enter" && sendMessage()}"
              />
              <button
                class="text-white bg-[#075E54] px-4 py-2 rounded-full disabled:opacity-50"
                onClick="${sendMessage}"
                disabled="${loading}"
              >
                ${loading ? "..." : "Enviar"}
              </button>
            </div>
          </div>
        `;
      }

      function App() {
        const [selectedBot, setSelectedBot] = useState(null);
        return html`
          ${selectedBot
            ? html`
              <${ChatApp} bot="${selectedBot}" />
            `
            : html`
              <${ChatSelector} onSelect="${setSelectedBot}" />
            `}
        `;
      }

      const setAppHeight = () => {
        const height = window.visualViewport
          ? window.visualViewport.height
          : window.innerHeight;
        document.documentElement.style.setProperty(
          "--app-height",
          `${height}px`,
        );
        document.getElementById("app").style.height = `${height}px`;
      };

      window.addEventListener("resize", setAppHeight);
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", setAppHeight);
      }
      setAppHeight();

      render(h(App), document.getElementById("app"));
    </script>
  </body>
</html>
